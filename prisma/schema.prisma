generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public"]
}

model Asset {
  id         String                    @id @default(cuid())
  name       String
  address    String?
  city       String?
  country    String?
  created_at DateTime                  @default(now())
  updated_at DateTime                  @updatedAt
  capex      Capex[]
  opex       Opex[]
  rentRoll   RentRollUnit[]
  tri        TheoreticalRentalIncome[]
  bbrData    BBRData[]
  oisData    OISData[]
  ejfData    EJFData[]
  pdfJobs    PdfJob[]

  @@map("asset")
  @@schema("public")
}

model TheoreticalRentalIncome {
  id          String   @id @default(cuid())
  assetId     String
  triYear     Int
  triAmount   Int
  vacancyLoss Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@map("theoretical_rental_income")
  @@schema("public")
}

model Capex {
  id                          String   @id @unique @default(cuid())
  asset_name                  String
  capex_year                  Int
  common_areas_actuals        Int
  units_renovations_actuals   Int
  elevator_maintnance_actuals Int
  roof_maintnance_actuals     Int
  fire_safety_actuals         Int
  outdoor_area_actuals        Int
  common_areas_budget         Int
  units_renovations_budget    Int
  elevator_maintnance_budget  Int
  roof_maintnance_budget      Int
  fire_safety_budget          Int
  outdoor_area_budget         Int
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt
  assetId                     String
  asset                       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, capex_year])
  @@map("capex")
  @@schema("public")
}

model Opex {
  id                             String   @id @unique @default(cuid())
  asset_name                     String
  opex_year                      Int
  actual_delinquency             Int
  actual_property_management_fee Int
  actual_leasing_fee             Int
  actual_property_taxes          Int
  actual_refuse_collection       Int
  actual_insurance               Int
  actual_cleaning                Int
  actual_facility_management     Int
  actual_service_subscriptions   Int
  actual_common_consumption      Int
  actual_home_owner_association  Int
  budget_delinquency             Int
  budget_property_management_fee Int
  budget_leasing_fee             Int
  budget_property_taxes          Int
  budget_refuse_collection       Int
  budget_insurance               Int
  budget_cleaning                Int
  budget_facility_management     Int
  budget_service_subscriptions   Int
  budget_common_consumption      Int
  budget_home_owner_association  Int
  created_at                     DateTime @default(now())
  updated_at                     DateTime @updatedAt
  assetId                        String
  asset                          Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, opex_year])
  @@map("opex")
  @@schema("public")
}

model RentRollUnit {
  assetId             String
  property_build_year Int
  property_name       String
  unit_address        String
  unit_zipcode        String
  utilites_cost       Int
  unit_type           String
  size_sqm            Int
  rooms_amount        Int
  bedrooms_amount     Int
  bathrooms_amount    Int
  rent_current_gri    Int
  rent_budget_tri     Int
  lease_start         String
  lease_end           String?
  tenant_name1        String
  tenant_name2        String
  unit_id             Int        @id @unique
  unit_door           Int
  unit_floor          Int
  tenant_number1      Int
  tenant_number2      Int
  units_status        RentStatus
  tenant_mail1        String
  tenant_mail2        String
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  asset               Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)
  pdfMatches          PdfParsedUnits[]

  @@map("rent_roll_unit")
  @@schema("public")
}

model Chat {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatMessages ChatMessage[]

  @@map("chat")
  @@schema("public")
}

model ChatMessage {
  id        String   @id @default(cuid())
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("chat_message")
  @@schema("public")
}

enum RentStatus {
  occupied
  vacant
  terminated

  @@schema("public")
}

enum PdfJobStatus {
  pending
  processing
  extracting
  matching
  completed
  failed

  @@schema("public")
}

enum MatchStatus {
  pending
  matched
  missing
  mismatched

  @@schema("public")
}

model PdfJob {
  id            String       @id @default(uuid()) @db.Uuid
  fileName      String       @map("file_name")
  filePath      String       @map("file_path")
  fileSizeBytes Int          @map("file_size_bytes")
  status        PdfJobStatus @default(pending)
  progress      Int          @default(0)
  errorMessage  String?      @map("error_message")
  retryCount    Int          @default(0) @map("retry_count")
  maxRetries    Int          @default(3) @map("max_retries")
  nextRetryAt   DateTime?    @map("next_retry_at")
  startedAt     DateTime?    @map("started_at")
  completedAt   DateTime?    @map("completed_at")
  matchingResult Json?       @map("matching_result")
  summary       String?      @map("summary")
  assetId       String?      @map("asset_id")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  asset        Asset?           @relation(fields: [assetId], references: [id], onDelete: SetNull)
  parsedUnits  PdfParsedUnits[]

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([assetId])
  @@map("pdf_job")
  @@schema("public")
}

model PdfParsedUnits {
  id                String      @id @default(uuid()) @db.Uuid
  jobId             String      @map("job_id") @db.Uuid
  unitAddress       String?     @map("unit_address")
  unitZipcode       String?     @map("unit_zipcode")
  unitDoor          Int?        @map("unit_door")
  unitFloor         Int?        @map("unit_floor")
  sizeSqm           Decimal?    @map("size_sqm") @db.Decimal(10, 2)
  rentCurrent       Decimal?    @map("rent_current") @db.Decimal(12, 2)
  tenantName        String?     @map("tenant_name")
  leaseStart        DateTime?   @map("lease_start") @db.Date
  leaseEnd          DateTime?   @map("lease_end") @db.Date
  normalizedAddress String?     @map("normalized_address")
  matchedUnitId     Int?        @map("matched_unit_id")
  matchStatus       MatchStatus @default(pending) @map("match_status")
  matchConfidence   Decimal?    @map("match_confidence") @db.Decimal(5, 4)
  matchMethod       String?     @map("match_method")
  createdAt         DateTime    @default(now()) @map("created_at")

  job         PdfJob        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  matchedUnit RentRollUnit? @relation(fields: [matchedUnitId], references: [unit_id], onDelete: SetNull)

  @@index([jobId])
  @@index([matchedUnitId])
  @@index([normalizedAddress])
  @@map("pdf_parsed_units")
  @@schema("public")
}

model BBRData {
  id              String   @id @default(cuid())
  propertyId      String?
  address         String
  zipCode         String
  city            String
  buildingYear    Int?
  totalArea       Float?
  residentialArea Float?
  commercialArea  Float?
  energyLabel     String?
  propertyValue   Float?
  landValue       Float?
  bbrNumber       String   @unique
  lastUpdated     DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  asset           Asset?   @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([address, zipCode])
  @@index([bbrNumber])
  @@map("bbr_data")
  @@schema("public")
}

model OISData {
  id              String   @id @default(cuid())
  propertyId      String?
  address         String
  zipCode         String
  city            String
  ownerName       String?
  ownerType       String?
  propertyType    String?
  registrationDate DateTime?
  lastUpdated     DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  asset           Asset?   @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([address, zipCode])
  @@map("ois_data")
  @@schema("public")
}

model EJFData {
  id              String   @id @default(cuid())
  propertyId      String?
  address         String
  zipCode         String
  city            String
  assessedValue   Float?
  taxBase         Float?
  propertyTax     Float?
  year            Int
  lastUpdated     DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  asset           Asset?   @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@unique([address, zipCode, year], name: "ejf_address_zip_year")
  @@index([address, zipCode, year])
  @@map("ejf_data")
  @@schema("public")
}

model DocumentAnalysis {
  id              String   @id @default(cuid())
  chatId          String?
  fileName        String
  documentType    String
  extractedData   Json
  propertyAddress String?
  propertyZipCode String?
  anomalies       Json?
  riskFlags       Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  anomaliesList   Anomaly[]

  @@index([propertyAddress, propertyZipCode])
  @@map("document_analysis")
  @@schema("public")
}

model Anomaly {
  id              String   @id @default(cuid())
  documentId      String
  type            String
  severity        String
  field           String
  expectedValue   String?
  actualValue     String?
  source          String
  description     String
  createdAt       DateTime @default(now())
  document        DocumentAnalysis @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([severity])
  @@map("anomaly")
  @@schema("public")
}
